{"version":3,"sources":["../../src/modules/automaticTags.js"],"names":["module","exports","tags","mongodb","subject","email_date","name","to","from","logs","reply_to","send_to","Promise","resolve","reject","count","tagId","template_id","is_email_send","findOne","reply_to_id","then","genuine","Tag","where","title","tagType","data","get_email_already_save","length","default_tag_id","id","toString","is_automatic_email_send","email_id","callback","sender_mail","tag_id","limit","sort","date","exec","err","response","catch","error","findAll","type","automatic","forEach","val","key","match","RegExp","Date","getTime","email","push","Template","default","parent_id","map","x","parseInt","result","filter","body","html","Smtp","status","smtp","send_automatic_tags_email","sendMail","text","emailLog","message","tagid"],"mappings":"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","file":"automaticTags.js","sourcesContent":["import db from \"../db\"\nimport _ from \"lodash\";\nimport constant from \"../models/constant\";\nimport mail from \"../modules/mail\";\nimport replace from \"../modules/replaceVariable\";\nimport config from \"../config\";\nimport email_log from \"../service/emaillogs\"\n\nmodule.exports = {\n    tags: function(mongodb, subject, email_date, name, to, from, logs, reply_to, send_to) {\n        return new Promise((resolve, reject) => {\n            let count = 0;\n            let tagId = [];\n            let template_id = [];\n            let is_email_send = 0;\n            mongodb.findOne({ reply_to_id: reply_to }).then((genuine) => {\n                if (genuine) {\n                    db.Tag.findOne({ where: { title: constant().tagType.genuine } })\n                        .then((data) => {\n                            get_email_already_save(to, function(tagId) {\n                                if (tagId.length) {\n                                    resolve({ tagId: tagId, default_tag_id: data.id.toString(), is_automatic_email_send: 1 })\n                                } else {\n                                    resolve({ tagId: [], default_tag_id: data.id.toString(), is_automatic_email_send: 1 })\n                                }\n                            })\n\n                            function get_email_already_save(email_id, callback) {\n                                mongodb.findOne({ sender_mail: email_id, tag_id: { \"$not\": { \"$size\": 0 } } }).limit(1).sort({ date: -1 }).exec(function(err, response) {\n                                    if (response) {\n                                        callback(response.tag_id)\n                                    } else {\n                                        callback([])\n                                    }\n\n                                })\n                            }\n\n                        })\n                        .catch((error) => { reject(error) })\n                } else {\n                    db.Tag.findAll({ where: { type: constant().tagType.automatic } })\n                        .then((data) => {\n                            if (data) {\n                                _.forEach(data, (val, key) => {\n                                    if ((subject.match(new RegExp(val.subject, 'gi'))) || ((val.to && val.from) && (new Date(email_date).getTime() < new Date(val.to).getTime() && new Date(email_date).getTime() > new Date(val.from).getTime())) || ((val.email) && (to.match(new RegExp(val.email, 'gi'))))) {\n                                        tagId.push(val.id.toString())\n                                        template_id.push(val.template_id);\n                                        if (!is_email_send && val.is_email_send)\n                                            is_email_send = val.is_email_send;\n                                    }\n                                })\n                                let default_tag_id = \"\";\n                                db.Template.findOne({\n                                    where: {\n                                        id: template_id[0]\n                                    }\n                                }).then((data) => {\n                                    db.Tag.findAll({ where: { type: constant().tagType.default, parent_id: { \"$in\": tagId.map(function(x) { return parseInt(x, 10); }) } } })\n                                        .then((result) => {\n                                            _.forEach(result,(val, key)=>{\n                                              if ((subject.match(new RegExp(val.subject, 'gi'))) || ((val.to && val.from) && (new Date(email_date).getTime() < new Date(val.to).getTime() && new Date(email_date).getTime() > new Date(val.from).getTime())) || ((val.email) && (to.match(new RegExp(val.email, 'gi'))))) {\n                                                default_tag_id = val.id.toString();\n                                            }  \n                                            })\n                                            if (data != null) {\n                                                replace.filter(data.body, name, tagId[0])\n                                                    .then((html) => {\n                                                        db.Smtp.findOne({ where: { status: 1 } })\n                                                            .then((smtp) => {\n                                                                if (config.send_automatic_tags_email === true && send_to && is_email_send) {\n                                                                    mail.sendMail(to, data.subject, constant().smtp.text, smtp, html, true)\n                                                                        .then((response) => {\n                                                                            response['tag_id'] = tagId;\n                                                                            email_log.emailLog(logs, response)\n                                                                                .then((data) => {\n                                                                                    if (response.status) {\n                                                                                        resolve({ message: \"Tempate Send Successfully\", tagId: tagId, is_automatic_email_send: 1, count: 1, template_id: template_id[0], reply_to_id: response.reply_to, default_tag_id: default_tag_id })\n                                                                                    } else {\n                                                                                        resolve({ message: \"Tempate Not Send Successfully\", tagId: tagId, is_automatic_email_send: 0, default_tag_id: default_tag_id })\n                                                                                    }\n                                                                                })\n                                                                        })\n\n                                                                } else {\n                                                                    resolve({ message: \"Email Not Send \", tagId: tagId, default_tag_id: default_tag_id })\n                                                                }\n                                                            })\n                                                    });\n                                            } else {\n                                                if (tagId.length != 0) {\n                                                    resolve({ message: \"Email Not send\", tagId: tagId, default_tag_id: default_tag_id })\n                                                } else {\n                                                    resolve({ message: \"Email Not send\", tagId: [] })\n                                                }\n                                            }\n                                        })\n                                })\n                            } else {\n                                resolve({ tagid: [] })\n                            }\n                        })\n                }\n            })\n\n        })\n    }\n};"]}